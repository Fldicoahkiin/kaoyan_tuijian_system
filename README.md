# 计算机考研院校可视化推荐系统 - 开发文档

## 1. 项目概述

本项目旨在为计算机专业考研学生提供一个集院校信息查询、可视化分析和个性化推荐于一体的 Web 应用。系统核心功能包括：

* **可视化大面板:** 动态展示全国计算机考研相关的宏观数据。主要包括：
  * **中间区域**: 可滚动的院校列表，展示 `院校名称`, `院校等级`, `省份`, `地区(A/B区)`, `计算机等级`。 (注: `24年招生人数` 和 `初试科目` 在此速览中暂不直接显示，详情页可见)
  * **左侧面板**:
    * 左上: 近三年计算机考研**总分国家线折线图**。
    * 左中: 近三年**政治/英语单科国家线柱状图**。
    * 左下: 近三年**数学/专业课国家线折线图**。
  * **右侧面板**:
    * 右上: 计算机考研**自命题 vs 408统考比例饼图**。
    * 右中/右下: **考研公告通知模块**(内容由后台管理，支持拖拽排序、编辑和删除)。
* **院校库查询:** 允许用户根据 `省份`, `地区(A/B区)`, `院校等级`, `院校名称`, `计算机等级` 等维度筛选院校，并按 `收藏人数` 或默认排序。查询结果以列表形式展示 `院校名称`, `院校等级`, `省份`, `地区(A/B区)`, `计算机等级`, `24年总招生`, `初试科目汇总`, `收藏人数`。
* **院校详情:** 展示院校的详细信息，包括 `学校简介`, `招生院系架构`, `专业代码对照表`, `考试科目`, `招生人数`, `学费学制`, `地区(A/B区)` 等。
* **个性化推荐:** 基于用户的个人情况（`目标分数`, `目标院校等级`, `偏好计算机等级`, `目标地区(省份或A/B区)`）和加权评分算法，推荐最合适的 Top N 院校 (默认为10所，分页显示)。推荐算法如下：
  * **推荐评分** = \(0.35 \times \text{分数相似度} + 0.2 \times \text{院校等级分} + 0.15 \times \text{计算机等级分} + 0.2 \times \text{地区匹配分} + 0.1 \times \text{热度分}\)
  * **权重规则:**

        | 指标                 | 权重 | 评分规则                                                                 |
        | -------------------- | ---- | ------------------------------------------------------------------------ |
        | 目标分数相似度       | 35%  | 基于用户预期分数与院校专业平均历年分数线的误差计算 (`max(0, 100 - (误差 * 2))`) |
        | 院校等级匹配度       | 20%  | 基础分: 985=100, 211=80, 双一流=60, 一般=30。若与用户目标等级匹配则为100，否则按基础分*0.7计算。 |
        | 计算机等级匹配度     | 15%  | 基础分: A+=100, A=90, ..., 无=20。若与用户偏好等级匹配则为该等级分数，若用户未设置偏好等级或学校等级低于偏好，则按比例降低。 |
        | 地区匹配 (省份/考区) | 20%  | 目标省份匹配=100, 目标考区匹配=50, 否则=0。用户可在个人资料设置省份。        |
        | 热度分 (收藏数)      | 10%  | (收藏数 / 50) * 100, 最高100分。                                         |
  * 输出结果列表展示 `院校名称`, `院校等级`, `省份`, `地区(A/B区)`, `计算机等级`, `24年总招生`, `收藏数`, `推荐分数`。
* **交互功能**:
  * **院校收藏**: 用户可在院校列表或详情页点击心形图标收藏/取消收藏院校，收藏结果计入用户个人中心的收藏列表和全局统计。
  * **页面跳转**: 支持从院校库、推荐结果列表点击进入院校详情页。
* **用户管理 (前后台):**
  * 支持用户注册、登录、登出 (使用 Flask-WTF 处理表单和 CSRF 保护)。
  * 用户可查看和编辑个人资料（学历、专业、目标地区、目标等级、**偏好计算机等级**、预期分数）。
  * 用户可查看收藏的院校列表。
  * 管理员可在后台查看用户列表、创建新用户（可设为管理员）、删除用户、查看用户详情、切换用户管理员状态 (相关操作均已添加 CSRF 保护)。
* **后台管理:** 提供管理员界面，用于管理用户、公告信息、首页图表数据。
  * **管理员认证**: 通过在用户 JSON 文件中手动设置 `is_admin: true` 实现。
  * **公告管理**: 管理员可添加、删除、编辑公告信息，并可拖拽排序。
  * **图表数据编辑**: 管理员可编辑首页"自命题 vs 408 比例"饼图的数据和国家线图表的数据。
  * **院校数据管理**: 管理员可查看院校列表，编辑院校顶层信息和院系专业JSON数据。
  * **爬虫触发**: 管理员可手动触发部分高校数据爬取更新任务。
  * **管理员设置**: 管理员可修改自己的登录密码。
  * 所有后台表单提交和 AJAX 操作均已添加 CSRF 保护。
* **系统日志**: 将关键操作记录到 `logs/app.log` 文件。

本项目的一个关键特点是**不依赖传统数据库**，所有数据（院校信息、国家线、公告、用户信息、收藏夹计数）均以 **JSON 文件** 形式存储在服务器的文件系统中 (`data/` 目录)。后端逻辑使用 Python 和 Flask 框架实现。

**重要提示:** 基于文件的用户数据存储和密码哈希（`werkzeug.security`）相比明文有改进，但**仍不适合生产环境**，存在并发写入风险、安全风险和性能瓶颈。

## 2. 技术栈

* **后端:**
  * **框架:** Flask
  * **表单与CSRF:** Flask-WTF
  * **数据处理:** JSON (用于运行时数据读写), Pandas (用于 `utils/data_processor.py` 数据预处理)
  * **密码处理:** Werkzeug
  * **日志:** Python `logging` 模块
  * **数据存储:** JSON 文件
  * **文件锁:** portalocker (用于并发文件访问控制)
  * **Web 服务器 (开发):** Flask 内建服务器
* **前端:**
  * **基础:** HTML, CSS, JavaScript
  * **可视化库:** ECharts
  * **UI 框架:** Bootstrap 5
  * **图标:** Font Awesome
  * **(后台公告排序):** SortableJS
* **开发工具:**
  * Python 3.x
  * pip (包管理)
  * Git (版本控制)

## 3. 项目结构

```text
computer_recommendation_system/
├── app.py                      # Flask 后端主应用文件
├── data/                       # 存放所有数据文件的文件夹
│   ├── schools.json            # 全国院校数据
│   ├── national_lines.json     # 国家线数据
│   ├── announcements.json      # 公告通知数据
│   ├── exam_type_ratios.json   # 首页饼图"自命题vs408比例"数据
│   ├── favorites_count.json    # 全局学校收藏数统计
│   └── users/                  # 存储用户信息的文件夹 (每个用户一个 JSON)
│       └── admin.json
├── logs/                       # 存放日志文件
│   └── app.log
├── static/                     # 存放前端静态文件
│   ├── css/
│   │   └── style.css           # 主要样式文件
│   └── js/
│       └── main.js             # 主要前端脚本
├── templates/                  # 存放 HTML 模板文件
│   ├── admin/                  # 管理后台模板
│   │   ├── base_admin.html
│   │   ├── dashboard.html
│   │   ├── users.html
│   │   ├── user_detail.html
│   │   ├── announcements.html
│   │   ├── admin_profile.html
│   │   ├── edit_exam_ratios.html # 编辑饼图比例数据页面
│   │   ├── edit_national_lines.html # 编辑国家线数据页面
│   │   ├── schools.html          # 后台院校列表
│   │   └── edit_school.html      # 后台编辑院校页面
│   ├── base.html               # 前台基础模板
│   ├── index.html              # 可视化大面板/首页
│   ├── school_list.html        # 院校库查询结果页
│   ├── school_detail.html      # 院校详情页
│   ├── recommendation.html     # 推荐结果页
│   ├── login.html
│   ├── register.html
│   ├── profile.html            # 用户个人中心
│   └── _flash_messages.html    # Flash消息模板片段
├── utils/                      # 存放工具脚本
│   ├── data_processor.py       # 初始数据处理脚本
│   └── scraper.py              # 爬虫脚本 (部分实现)
├── requirements.txt            # Python 依赖库
├── README.md                   # 项目说明和开发文档
└── 择校文档.xlsx             # 原始数据文件 (示例)
```

## 4. 数据结构

核心数据存储在 `data/` 目录下的 JSON 文件中。

### `schools.json`

包含所有院校信息的主要数据文件，结构如下：

```json
[
  {
    "id": "院校名称",
    "name": "院校名称",
    "level": "985/211/双一流/一般",
    "province": "省份",
    "region": "A区/B区",
    "intro": "院校简介",
    "computer_rank": "计算机学科评估等级(A+/A/A-/B+/B/B-/C+/C/C-/无评级)",
    "departments": [
      {
        "department_name": "院系名称",
        "majors": [
          {
            "major_code": "专业代码",
            "major_name": "专业名称",
            "exam_subjects": "初试科目",
            "reference_books": "参考书目",
            "retrial_subjects": "复试科目",
            "enrollment": { 
              "2022": 0, 
              "2023": 0, 
              "2024": 0 
            },
            "tuition_duration": "学费学制",
            "score_lines": {
              "2022": "分数线字符串",
              "2023": "分数线字符串",
              "2024": "分数线字符串"
            },
            "admission_info_23": "23年录取情况",
            "admission_info_24": "24年录取情况"
          }
        ]
      }
    ],
    "enrollment_24_school_total": 100,
    "exam_subjects_summary": "初试科目汇总"
  }
]
```

### `national_lines.json`

存储各科国家线数据，结构如下：

```json
{
  "computer_science_total": {
    "years": ["2023", "2024", "2025"],
    "scores": {
      "A区": [290, 285, null],
      "B区": [280, 275, null]
    }
  },
  "politics": {
    "years": ["2023", "2024", "2025"],
    "scores": {
      "A区": [55, 55, null],
      "B区": [55, 55, null]
    }
  },
  "english_one": {
    "years": ["2023", "2024", "2025"],
    "scores": {
      "A区": [55, 55, null],
      "B区": [55, 55, null]
    }
  },
  "english_two": {
    "years": ["2023", "2024", "2025"],
    "scores": {
      "A区": [55, 55, null],
      "B区": [55, 55, null]
    }
  },
  "math_one": {
    "years": ["2023", "2024", "2025"],
    "scores": {
      "A区": [55, 55, null],
      "B区": [55, 55, null]
    }
  },
  "math_two": {
    "years": ["2023", "2024", "2025"],
    "scores": {
      "A区": [55, 55, null],
      "B区": [55, 55, null]
    }
  }
}
```

### `announcements.json`

存储公告信息列表：

```json
[
  {
    "title": "公告标题",
    "url": "公告链接"
  }
]
```

### `data/exam_type_ratios.json`

存储首页"自命题 vs 408 比例"饼图的原始数据：

```json
[
  {
    "value": 60,
    "name": "自命题"
  },
  {
    "value": 40,
    "name": "408统考"
  }
]
```

### `data/favorites_count.json`

存储全局各学校被收藏次数的统计：

```json
{
  "学校ID_1": 15,
  "学校ID_2": 5,
  ...
}
```

### `data/homepage_config.json`

存储首页图表的配置信息：

```json
{
  "national_line_total_title": "近三年总分国家线趋势",
  "national_line_politics_title": "近三年政治/英语单科线",
  "national_line_others_title": "近三年数学/专业课单科线",
  "exam_type_ratio_title": "自命题 vs 408 比例"
}
```

### `data/users/username.json`

存储单个用户的信息：

```json
{
  "username": "string",        // 用户名 (与文件名一致)
  "password_hash": "string",   // Werkzeug 生成的密码哈希
  "is_admin": boolean,       // 是否为管理员 (默认为 false)
  "profile": {               // 用户个人资料和偏好
    "education_background": "string",
    "major_area": "string",
    "target_location": "string", // 省份
    "target_level": "string",    // 985, 211, etc.
    "target_rank": "string",     // A+, A, A-, B+, ..., 无评级
    "expected_score": number | null
  },
  "favorites": ["string", ...] // 收藏的学校 ID (通常是学校名称) 列表
}
```

### `data/crawler/`

爬虫输出目录：

* `crawler_raw_data.json`: 爬虫原始数据，包含完整爬取结果
* `crawler_schools.csv`: 爬取的学校和URL信息
* `crawler_summary.json`: 爬虫处理后的汇总数据

## 5. 已实现功能

* **核心展示**:
  * 可视化大面板 (含国家线图、考试类型比例图、公告、滚动院校列表)
  * 院校库查询 (支持多维度筛选、分页)
  * 院校详情页
* **用户系统**:
  * 注册、登录、登出 (使用 Flask-WTF 和 CSRF 保护)
  * 个人资料查看与修改 (支持偏好地区、等级、**计算机等级**、预期分数等)
  * 院校收藏与取消收藏 (实时更新收藏数)
  * 收藏夹列表展示
* **推荐系统**: 基于用户偏好和加权算法的 Top N 院校推荐 (分页显示)。
* **管理后台**:
  * 管理员登录与权限控制
  * 仪表盘概览
  * 用户管理 (列表、创建、删除、查看详情、切换管理员状态)
  * 公告管理 (添加、编辑、删除、拖拽排序)
  * 首页图表数据编辑 (国家线、考试类型比例)
  * 院校数据管理 (列表查看、顶层信息编辑、院系专业JSON编辑)
  * 爬虫手动触发
  * 管理员密码修改
  * 完整的 CSRF 保护
* **日志记录**: 关键操作记录到 `logs/app.log` 文件。
* **数据爬取 (部分)**: 已实现针对 **四川大学** 和 **电子科技大学** 的专业目录和近三年分数线的爬取与合并逻辑 (`utils/scraper.py`)。
* **UI 风格**:
  * 固定为深色科技感主题，并对全局样式和组件进行了统一重构。

## 6. 运行说明

1. **环境设置**: 确保已安装 Python 3.x 和 pip。建议使用虚拟环境.venv。

    ```bash
    python -m venv .venv
    source .venv/bin/activate   # 激活虚拟环境 (Linux/macOS)
    .venv\Scripts\activate      # 激活虚拟环境 (Windows)
    ```

2. **安装依赖**: 在激活虚拟环境后，安装所需库：

    ```bash
    pip install -r requirements.txt
    ```

3. **准备数据**:

* 运行 `python utils/data_processor.py` 来生成初始的 `schools.json` (如果原始 Excel 文件存在)。
* 确保 `data/national_lines.json`, `data/announcements.json`, `data/exam_type_ratios.json` 文件存在且有初始数据（或为空列表/字典）。
* `data/favorites_count.json` 会在用户首次收藏时自动创建。

4. **设置管理员**: 首次运行时，需要先注册一个用户，然后**手动修改**对应的 `data/users/用户名.json` 文件，在顶层添加 `"is_admin": true,`。
5. **运行应用**: 在项目根目录下运行：

    ```bash
    python app.py
    ```

6. **访问应用**: 打开浏览器访问 `http://127.0.0.1:5001/`。
7. **访问后台**: 使用管理员账户登录后，访问 `http://127.0.0.1:5001/admin/`。

## 7. 待办事项 (To-Do List)

* **[进行中]** **爬虫模块 (`utils/scraper.py`)**:
  * **[待定]** **扩展爬取范围**: 添加对 `TARGET_SCHOOLS` 列表中其他学校的特定解析逻辑和数据抓取。
  * **[待定]** **健壮性与容错**: 增强错误处理，添加更详细的日志记录。
  * **[待定]** **更新机制**: 实现增量更新或定期完全更新的策略。
  * **[待定]** **代理/延时**: 加入代理 IP 和请求延时，防止被封禁。
* **[待完善]** **前端页面 (`templates/`, `static/`)**:
  * 细节样式打磨。
  * 可视化大面板其余图表细节优化。
  * 院校详情页可以考虑加入 ECharts 展示历年分数线（目前只在后端逻辑中有准备）。
* **[待完成]** **后台功能**:
  * **[待定]** 实现更精细的院校信息编辑界面（替代或辅助JSON编辑）。
  * **[待定]** 爬虫状态监控/管理界面。
* **[可选]** **部署优化**:
  * 考虑使用 Gunicorn/uWSGI + Nginx 进行生产环境部署。
  * 考虑使用更健壮的数据存储方案（如 SQLite, PostgreSQL）替代 JSON 文件。
  * 考虑使用后台任务队列（如 Celery）运行爬虫。

## 8. 爬虫模块 (`utils/scraper.py`)

本模块负责从指定高校的研究生招生网站爬取最新的招生信息，特别是针对四川省高校近三年的计算机相关专业数据，用以补充和更新核心数据文件 `data/schools.json`。

### 8.1 设计目标

* **目标院校**: 重点关注四川省内招收计算机相关专业研究生的高校。
* **目标专业**: 涵盖主流计算机相关专业代码，包括：
  * `081200` 计算机科学与技术 (学硕)
  * `083500` 软件工程 (学硕)
  * `083900` 网络空间安全 (学硕)
  * `085400` 电子信息 (专硕大类)
  * `085404` 电子信息-计算机技术 (专硕方向)
  * `085405` 电子信息-软件工程 (专硕方向)
  * `085410` 电子信息-人工智能 (专硕方向)
  * `085411` 电子信息-大数据技术与工程 (专硕方向)
* **目标数据维度 (近三年: 2022, 2023, 2024)**:
  * **招生人数**: 各专业的计划招生人数或实际录取人数。
  * **考试科目**: 初试科目代码和名称。
  * **复试分数线**: 各专业进入复试的总分线和单科线。
  * **参考书目**: 专业课初试和复试的推荐参考书。
  * **学费与学制**: 各专业的学费标准和基本学习年限。
  * **录取情况**: 如最高分、最低分、平均分、拟录取名单公示链接等。
* **数据输出**:
  * 将爬取的原始数据输出到 `data/crawler/crawler_raw_data.json`
  * 将学校URL信息输出到 `data/crawler/crawler_schools.csv`
  * 将处理后的数据合并到 `data/schools.json`，保持原有结构

### 8.2 工作流程

1. **加载现有数据**: 启动时，从 `data/schools.json` 文件读取现有学校数据。
2. **爬取目标院校数据**: 针对四川省内有计算机相关专业的高校进行爬取。
3. **数据解析与结构化**: 将爬取的HTML内容解析为结构化数据。
4. **导出爬取数据**: 将原始爬取数据导出到单独的JSON和CSV文件中。
5. **合并更新数据**: 将爬取的数据与现有的schools.json数据合并，保持原有结构。
6. **保存更新后的数据**: 将合并后的数据保存回schools.json文件。
