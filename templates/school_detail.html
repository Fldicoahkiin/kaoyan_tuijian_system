{% extends "base.html" %}

{% block title %}{{ school.name }} - 详情 - {{ super() }}{% endblock %}

{% block head_extra %}
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.3.3/dist/echarts.min.js"></script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-3">
        <div class="col-md-8">
            <h1 class="display-5">{{ school.name }}</h1>
            <p class="lead">
                <span class="badge {% if school.level == '985' %}bg-danger{% elif school.level == '211' %}bg-warning text-dark{% else %}bg-secondary{% endif %} me-2">{{ school.level or '未知等级' }}</span>
                <span class="text-muted"><i class="fas fa-map-marker-alt"></i> {{ school.province or '未知' }} ({{ school.region or '未知地区' }})</span>
            </p>
        </div>
        <div class="col-md-4 text-md-end align-self-center">
            {% if 'username' in session %}
            <form action="{{ url_for('toggle_favorite', school_id=school.id) }}" method="POST">
                <button type="submit" class="btn {% if is_favorite %}btn-danger{% else %}btn-outline-danger{% endif %} btn-lg">
                    <i class="fas fa-heart"></i> {% if is_favorite %}已收藏{% else %}收藏院校{% endif %}
                </button>
            </form>
            {% else %}
            <a href="{{ url_for('login', next=request.url) }}" class="btn btn-outline-danger btn-lg">
                <i class="fas fa-heart"></i> 登录后收藏
            </a>
            {% endif %}
            <p class="text-muted mt-1">收藏人数: {{ favorites_count }}</p>
        </div>
    </div>

    <div class="row gy-4">
        <!-- 左侧主要信息 -->
        <div class="col-lg-8">
            <!-- 学校简介和评级 -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-info-circle"></i> 基本信息
                </div>
                <div class="card-body">
                    <p><strong><i class="fas fa-book-open"></i> 简介:</strong> {{ school.intro or '暂无简介' }}</p>
                    <p><strong><i class="fas fa-trophy"></i> 计算机评级:</strong> {{ school.computer_rank or '暂无评级' }}</p>
                    <p><strong><i class="fas fa-question-circle"></i> 自命题/408:</strong> {{ school.self_vs_408 or '待判断' }}</p>
                </div>
            </div>

            <!-- 院系与专业信息 -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-sitemap"></i> 院系与专业详情
                </div>
                <div class="accordion" id="departmentsAccordion">
                    {% if school.departments %}
                        {% for department in school.departments %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading{{ loop.index }}">
                                <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" aria-expanded="{{ 'true' if loop.first else 'false' }}" aria-controls="collapse{{ loop.index }}">
                                    <strong>{{ department.department_name or '未知院系' }}</strong>
                                </button>
                            </h2>
                            <div id="collapse{{ loop.index }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}" aria-labelledby="heading{{ loop.index }}" data-bs-parent="#departmentsAccordion">
                                <div class="accordion-body">
                                    {% if department.majors %}
                                        <ul class="list-group list-group-flush">
                                            {% for major in department.majors %}
                                                <li class="list-group-item">
                                                    <h5>{{ major.major_name | default('未知专业') }} ({{ major.major_code | default('无代码') }})</h5>
                                                    <p><small class="text-muted">{{ major.degree_type | default('') }} | {{ major.study_type | default('') }}</small></p>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <p><strong>初试科目:</strong> <pre class="bg-light p-2 rounded">{{ major.exam_subjects or '-' }}</pre></p>
                                                            <p><strong>参考书目:</strong> {{ major.reference_books or '-' }}</p>
                                                            <p><strong>复试科目:</strong> {{ major.retrial_subjects or '-' }}</p>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <p><strong>24招生人数:</strong> {{ major.enrollment_24 or '-' }}</p>
                                                            <p><strong>学费学制:</strong> {{ major.tuition_duration or '-' }}</p>
                                                            <p><strong>23/24录取信息:</strong>
                                                                <pre class="bg-light p-2 rounded">23: {{ major.admission_info_23 or '-' }}
24: {{ major.admission_info_24 or '-' }}</pre>
                                                            </p>
                                                        </div>
                                                    </div>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p class="text-muted">该院系下暂无专业信息。</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="card-body">
                            <p class="text-muted">暂无院系信息。</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- 右侧分数线图表 -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-line"></i> 近三年复试线趋势 (计算机相关专业)
                </div>
                <div class="card-body">
                    <div id="scoreLineChart" style="width: 100%; height: 400px;"></div>
                    <p class="text-muted small mt-2">注：数据来源于爬取的历年分数线，可能包含不同专业的分数，仅供参考。</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    var scoreLineChart = echarts.init(document.getElementById('scoreLineChart'));
    var schoolData = {{ school | tojson }};

    // 提取分数线数据
    let years = new Set();
    let seriesData = [];
    let legendData = [];

    if (schoolData.departments) {
        schoolData.departments.forEach(dept => {
            if (dept.majors) {
                dept.majors.forEach(major => {
                    if (major.score_lines) {
                        let majorKey = `${major.major_name || '专业'}(${major.major_code || '未知代码'})`;
                        let scores = [];
                        let currentYears = [];
                        // 确保按年份排序
                        let sortedYears = Object.keys(major.score_lines).sort();

                        sortedYears.forEach(year => {
                            years.add(year);
                            currentYears.push(year);
                            // 尝试提取纯数字分数
                            let scoreText = major.score_lines[year];
                            let scoreMatch = scoreText ? String(scoreText).match(/^(\d+)/) : null;
                            scores.push(scoreMatch ? parseInt(scoreMatch[1]) : null); // 如果没有数字，设为null
                        });

                        if (scores.some(s => s !== null)) { // 只添加有有效分数的系列
                             legendData.push(majorKey);
                             seriesData.push({
                                name: majorKey,
                                type: 'line',
                                data: scores,
                                // MarkPoint/MarkLine can be added here if needed
                                smooth: true
                            });
                        }
                    }
                });
            }
        });
    }

    let sortedYearsArray = Array.from(years).sort();

    // 重新整理 seriesData 以匹配完整的 sortedYearsArray
    let finalSeriesData = seriesData.map(series => {
        let alignedData = [];
        let originalDataIndex = 0;
        // 假设 series.data 和它对应的年份顺序与 sortedYears 一致
        // 这里需要更健壮的逻辑来根据年份匹配分数
        // 简化：假设 major.score_lines 的 key 是按年份顺序的
        // 找到当前 series 在原始数据中的年份
        let majorYears = [];
        schoolData.departments.forEach(dept => {
             dept.majors.forEach(major => {
                 if (`${major.major_name || '专业'}(${major.major_code || '未知代码'})` === series.name && major.score_lines){
                     majorYears = Object.keys(major.score_lines).sort();
                 }
             });
        });

        sortedYearsArray.forEach(year => {
            let yearIndex = majorYears.indexOf(year);
            if (yearIndex !== -1) {
                alignedData.push(series.data[yearIndex]);
            } else {
                alignedData.push(null); // 如果该年份没有数据，填充null
            }
        });

        return { ...series, data: alignedData };
    });


    var option = {
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data: legendData,
            bottom: 10,
            type: 'scroll' // 如果图例太多，允许滚动
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '15%', // 为图例留出空间
            containLabel: true
        },
        xAxis: {
            type: 'category',
            boundaryGap: false,
            data: sortedYearsArray
        },
        yAxis: {
            type: 'value',
            name: '分数线',
            min: function(value) { // 动态设置最小值，避免从0开始
                return Math.max(0, Math.floor(value.min * 0.9));
            }
        },
        series: finalSeriesData
    };

    scoreLineChart.setOption(option);

    // Optional: Add resize listener
    window.addEventListener('resize', function () {
        scoreLineChart.resize();
    });
</script>
{% endblock %} 